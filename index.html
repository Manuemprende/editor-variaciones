<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Editor de Singularidad para ADS ‚Äî Lite</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
:root{--bg:#0b1320;--bg2:#0c1526;--card:#0e1626;--stroke:#1b2a4d;--fg:#e9f0ff;--muted:#a9b8d6;--primary:#3b82f6}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg);
font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased}
.wrap{max-width:1120px;margin:auto;padding:28px}
.h{display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:10px}
h1{margin:0;font-size:26px;font-weight:800} .muted{color:var(--muted);font-size:13.5px}
.grid{display:grid;grid-template-columns:1.12fr .88fr;gap:22px}@media(max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:16px}
.drop,.drop-mini{border:2px dashed var(--stroke);border-radius:14px;background:#0a1324;display:flex;align-items:center;justify-content:center;cursor:pointer}
.drop{min-height:190px} .drop-mini{min-height:74px}
.drop.dragover{border-color:var(--primary)} .hidden{display:none!important}
.preview{border:1px solid var(--stroke);border-radius:12px;background:#0b1426;padding:14px;min-height:300px;display:flex;align-items:center;justify-content:center;overflow:hidden}
video,canvas{max-width:100%;max-height:520px;border-radius:10px}
.btn{border:1px solid #21345e;background:#101a32;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:700}
.btn:hover{background:#0d182f} .btn.p{background:var(--primary);border-color:#2c6ee8;color:#0a1020}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center} .grow{flex:1}
input[type="text"],input[type="number"],select,textarea{background:#0b162e;border:1px solid #21345e;color:#e9f0ff;border-radius:10px;padding:9px 10px}
textarea{min-height:100px;width:100%}
.kv{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
.progress{height:10px;background:#0a1428;border:1px solid #1c2f55;border-radius:999px;overflow:hidden;margin-top:12px}
.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--primary),#67a5ff)}
.badge{border:1px solid #21345e;padding:4px 8px;border-radius:999px;font-size:12px}
.small{font-size:12.5px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="h">
    <h1>Editor de Singularidad para ADS ‚Äî Lite</h1>
    <div class="muted">Variaciones sutiles (invisibles), A/B en exportaci√≥n, subt√≠tulos y recortes. 100% en tu navegador.</div>
  </div>

  <div class="grid">
    <!-- IZQ -->
    <div class="card">
      <div id="drop" class="drop" tabindex="0" role="button" aria-label="Subir archivo">
        <div style="text-align:center">
          <div style="font-weight:800">Suelta o haz clic para imagen / video</div>
          <div class="small">JPG, PNG, GIF, WEBP o MP4 (‚â§ 15MB)</div>
        </div>
      </div>
      <input id="file" class="hidden" type="file" accept="image/png,image/jpeg,image/gif,image/webp,video/mp4"/>

      <div id="info" class="kv hidden" style="margin-top:10px">
        <div id="fname" class="small"></div>
        <button id="change" class="btn">Cambiar</button>
      </div>

      <div id="preview" class="preview" style="margin-top:10px"><div class="small">Tu vista previa aparecer√° aqu√≠</div></div>

      <div class="row" style="margin-top:10px">
        <button id="mirror" class="btn" disabled>Espejo ‚Üî</button>
        <button id="clear" class="btn" disabled>Limpiar</button>
        <span id="perfTag" class="badge">Modo rendimiento: ON</span>
      </div>
    </div>

    <!-- DER -->
    <div class="card">
      <div class="kv">
        <label><b>Variaciones (imagen o Video)</b></label>
        <input id="count" type="number" min="1" max="10" value="6" style="width:70px;text-align:center"/>
      </div>

      <div id="imgHelp" class="small" style="margin-top:-6px">Para video siempre se exporta 1, pero puedes elegir MP4 y/o WebM.</div>

      <div class="kv"><label><b>Nombre del ZIP</b></label><input id="zipname" type="text" value="variaciones_ads" class="grow"/></div>
      <div class="kv"><label><b>Semilla</b></label><div class="row grow"><input id="seed" type="text" placeholder="vac√≠o = aleatoria" class="grow"/><button id="rnd" class="btn">üé≤</button></div></div>

      <div id="vbox" class="hidden">
        <div class="kv"><b>Duraci√≥n</b>
          <div class="row">
            <label class="row"><input type="radio" name="dur" id="durFull" checked> Completa</label>
            <label class="row"><input type="radio" name="dur" id="durClip"> Recortar a <input id="sec" type="number" min="3" max="120" value="12" style="width:64px"> s</label>
            <label class="row"><input type="checkbox" id="randStart"> inicio aleatorio</label>
          </div>
        </div>

        <div class="kv"><b>Segmentos (opcional)</b>
          <input id="segments" type="text" placeholder="ej: 0-3, 6-10" class="grow"/>
        </div>

        <div class="kv"><b>Formato</b>
          <div class="row">
            <select id="format">
              <option value="video/mp4;codecs=h264">MP4 H.264</option>
              <option value="video/webm;codecs=vp9">WebM VP9</option>
            </select>
            <label class="row"><input id="bothFormats" type="checkbox" checked> Exportar ambos (MP4+WebM)</label>
          </div>
        </div>

        <div class="kv"><b>A/B por formato</b><label class="row"><input id="abPerFmt" type="checkbox" checked> Distinta semilla MP4/WebM</label></div>
        <div class="small" id="fmtNote"></div>
      </div>

      <div class="kv"><b>Invisibles</b>
        <div></div>
      </div>
      <div class="row" style="margin-bottom:8px">
        <label class="row"><input id="optBorder" type="checkbox" checked> Borde sutil</label>
        <label class="row"><input id="optBorderMulti" type="checkbox"> Borde multicolor</label>
        <label class="row"><input id="optShapes" type="checkbox" checked> Figuras casi invisibles</label>
        <label class="row"><input id="optStripes" type="checkbox" checked> Franjas casi invisibles</label>
        <label class="row"><input id="optWM" type="checkbox" checked> Marca de agua centrada</label>
      </div>

      <div class="kv"><b>A/B sutil</b>
        <div class="row">
          <label class="row"><input id="abEnable" type="checkbox" checked> Activar (exportaci√≥n)</label>
          <label class="row"><input id="abPreview" type="checkbox"> Previsualizar (m√°s pesado)</label>
          <select id="abIntensity">
            <option value="low" selected>Suave</option><option value="mid">Media</option><option value="high">Alta</option>
          </select>
        </div>
      </div>

      <div class="kv"><b>Subt√≠tulos</b><label class="row"><input id="subsEnable" type="checkbox"> Agregar</label></div>
      <div id="subsBox" class="hidden">
        <div class="row">
          <button id="subsLoad" class="btn">Cargar SRT/VTT</button><input id="subsFile" type="file" accept=".srt,.vtt,.txt" class="hidden">
          <button id="subsPaste" class="btn">Pegar texto</button>
          <button id="subsClear" class="btn">Quitar</button>
        </div>
        <textarea id="subsText" class="hidden" placeholder="Pega SRT/VTT o una frase por l√≠nea"></textarea>
        <div class="row">
          <label class="row"><input id="subsAuto" type="checkbox"> Autogenerar</label>
          <label class="row">Duraci√≥n <input id="subsDur" type="number" min="1" max="10" value="2" style="width:60px"> s</label>
          <label class="row">Tama√±o <input id="subsSize" type="number" min="12" max="48" value="24" style="width:70px"></label>
          <label class="row"><input id="subsBg" type="checkbox" checked> Fondo</label>
        </div>
      </div>

      <div class="kv"><b>Logo</b><span class="small">PNG/JPG para marca de agua</span></div>
      <div id="dropLogo" class="drop-mini" tabindex="0">Arrastra tu logo o haz clic</div>
      <input id="logoFile" class="hidden" type="file" accept="image/png,image/jpeg"/>
      <div id="logoInfo" class="small hidden" style="margin-top:6px"></div>

      <div class="progress"><div id="bar" class="bar"></div></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="cancel" class="btn" disabled>Cancelar</button>
        <button id="download" class="btn p" disabled>Descargar variaciones (.zip)</button>
      </div>

      <div class="small" style="margin-top:8px">Consejo: deja ‚ÄúPreview A/B‚Äù apagado para m√°xima fluidez. A/B se aplica al exportar.</div>
    </div>
  </div>
</div>

<script>
(()=>{
// ---------- util cortos
const $=id=>document.getElementById(id); const on=(el,ev,fn)=>el.addEventListener(ev,fn);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const genSeed=()=>`ads-${Date.now().toString(16).slice(-6)}`;
const makeRNG=s=>{let a=(function h(t){let r=2166136261>>>0;for(let i=0;i<t.length;i++){r^=t.charCodeAt(i);r=Math.imul(r,16777619)}return r>>>0})(s||'x')|0;return ()=>{a=a+0x6D2B79F5|0;let t=Math.imul(a^a>>>15,1|a);t=t+Math.imul(t^t>>>7,61|t)^t;return((t^t>>>14)>>>0)/4294967296}};
const throttle=(fn,ms)=>{let t=0;return(...a)=>{const n=Date.now();if(n-t>ms){t=n;fn(...a)}}};
const setProgress=p=>{$('bar').style.width=Math.max(0,Math.min(100,p))+'%';};
const download=(blob,name)=>{const a=document.createElement('a');const u=URL.createObjectURL(blob);a.href=u;a.download=name;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(u),1200);};

// ---------- estado
const MAX_VIDEO=15*1024*1024;
const S={file:null,kind:null,url:null,mirror:false,logo:null,abort:false,seed:null,subs:[],previewTimer:null,perf:true};

// ---------- elementos
const E={drop:$('drop'),file:$('file'),info:$('info'),fname:$('fname'),change:$('change'),
preview:$('preview'),mirror:$('mirror'),clear:$('clear'),perfTag:$('perfTag'),
count:$('count'),zip:$('zipname'),rnd:$('rnd'),seed:$('seed'),
vbox:$('vbox'),durFull:$('durFull'),durClip:$('durClip'),sec:$('sec'),rand:$('randStart'),segments:$('segments'),
format:$('format'),both:$('bothFormats'),abPerFmt:$('abPerFmt'),fmtNote:$('fmtNote'),
optBorder:$('optBorder'),optBorderMulti:$('optBorderMulti'),optShapes:$('optShapes'),optStripes:$('optStripes'),optWM:$('optWM'),
abEnable:$('abEnable'),abPreview:$('abPreview'),abIntensity:$('abIntensity'),
subsEnable:$('subsEnable'),subsBox:$('subsBox'),subsLoad:$('subsLoad'),subsFile:$('subsFile'),subsPaste:$('subsPaste'),subsText:$('subsText'),subsClear:$('subsClear'),subsAuto:$('subsAuto'),subsDur:$('subsDur'),subsSize:$('subsSize'),subsBg:$('subsBg'),
dropLogo:$('dropLogo'),logoFile:$('logoFile'),logoInfo:$('logoInfo'),
download:$('download'),cancel:$('cancel'),imgHelp:$('imgHelp')
};

// ---------- UI base
function setEnabled(v){E.download.disabled=!v;E.clear.disabled=!v;E.mirror.disabled=!v;}
function reset(){ if(S.url) URL.revokeObjectURL(S.url); Object.assign(S,{file:null,kind:null,url:null,mirror:false,logo:null,abort:false,seed:null,subs:[]});
  E.preview.innerHTML='<div class="small">Tu vista previa aparecer√° aqu√≠</div>'; E.info.classList.add('hidden'); E.drop.classList.remove('hidden'); setEnabled(false);
  E.count.disabled=false; E.vbox.classList.add('hidden'); E.imgHelp.classList.remove('hidden'); if(S.previewTimer){cancelAnimationFrame(S.previewTimer);S.previewTimer=null;}
}
on(E.clear,'click',reset);
on(E.mirror,'click',()=>{S.mirror=!S.mirror;E.mirror.textContent=S.mirror?'Espejo ACTIVADO ‚Üî':'Espejo ‚Üî'; renderPreviewLite();});
on(E.rnd,'click',()=>{E.seed.value=genSeed(); renderPreviewLite();});

// subida (sin doble modal)
const openPicker=()=>{E.file.value='';E.file.click();}; on(E.drop,'click',openPicker);
on(E.drop,'keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();openPicker();}});
['dragenter','dragover'].forEach(ev=>on(E.drop,ev,e=>{e.preventDefault();E.drop.classList.add('dragover');}));
['dragleave','drop'].forEach(ev=>on(E.drop,ev,e=>{e.preventDefault();E.drop.classList.remove('dragover');}));
on(E.drop,'drop',e=>{const f=e.dataTransfer.files?.[0]; if(f) handleFile(f);});
on(E.file,'change',e=>{const f=e.target.files?.[0]; if(f) handleFile(f);});
on(E.change,'click',openPicker);

async function handleFile(f){
  const isImg=/^image\/(png|jpeg|gif|webp)$/.test(f.type);
  const isVid=f.type==='video/mp4';
  if(!(isImg||isVid)) return alert('Formato no soportado.');
  if(isVid && f.size>MAX_VIDEO) return alert('Video > 15MB.');

  S.file=f; S.kind=isImg?'image':'video';
  if(S.url) URL.revokeObjectURL(S.url); S.url=URL.createObjectURL(f);
  E.fname.textContent=`${f.name} ‚Ä¢ ${Math.round(f.size/1024)} KB`;
  E.info.classList.remove('hidden'); E.drop.classList.add('hidden');
  setEnabled(true); S.seed=genSeed();

  if(S.kind==='video'){ E.count.value=1; E.count.disabled=true; E.vbox.classList.remove('hidden'); E.imgHelp.classList.add('hidden'); }
  else{ E.count.disabled=false; E.vbox.classList.add('hidden'); E.imgHelp.classList.remove('hidden'); }
  renderPreviewLite();
  updateFmtNote();
}

// ---------- LOGO
const pickLogo=()=>{E.logoFile.value='';E.logoFile.click();};
on(E.dropLogo,'click',pickLogo); on(E.dropLogo,'keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();pickLogo();}});
on(E.logoFile,'change',e=>{
  const f=e.target.files?.[0]; if(!f) return; if(!/^image\/(png|jpeg)$/.test(f.type)) return alert('Logo PNG/JPG');
  const u=URL.createObjectURL(f); const img=new Image(); img.onload=()=>{S.logo=img;URL.revokeObjectURL(u);E.logoInfo.textContent='Logo: '+f.name;E.logoInfo.classList.remove('hidden'); renderPreviewLite();}; img.src=u;
});

// ---------- SUBT√çTULOS
on(E.subsEnable,'change',()=>{E.subsBox.classList.toggle('hidden',!E.subsEnable.checked); renderPreviewLite();});
on(E.subsLoad,'click',()=>E.subsFile.click());
on(E.subsFile,'change',async e=>{const f=e.target.files?.[0]; if(!f)return; const txt=await f.text(); S.subs=parseSubs(txt); renderPreviewLite();});
on(E.subsPaste,'click',()=>E.subsText.classList.toggle('hidden'));
on(E.subsText,'input',throttle(()=>{
  if(E.subsAuto.checked){S.subs=autoFromText(E.subsText.value,parseInt(E.subsDur.value||'2',10));}
  else S.subs=parseSubs(E.subsText.value);
  renderPreviewLite();
},200));
on(E.subsClear,'click',()=>{S.subs=[];E.subsText.value=''; renderPreviewLite();});
['subsAuto','subsDur','subsSize','subsBg','abPreview','abIntensity','optBorder','optBorderMulti','optShapes','optStripes','optWM','format','both','abPerFmt','durFull','durClip','sec','randStart','segments'].forEach(id=>{
  const el=$(id); if(el) on(el,'change',throttle(renderPreviewLite,120));
});

// ---------- PREVIEW LITE (bajo FPS, sin bucles costosos por defecto)
function renderPreviewLite(){
  if(!S.file){E.preview.innerHTML='<div class="small">Tu vista previa aparecer√° aqu√≠</div>'; return;}
  if(S.previewTimer){cancelAnimationFrame(S.previewTimer);S.previewTimer=null;}
  E.preview.innerHTML='';

  const seed = (E.seed.value||S.seed||genSeed());
  const R0 = makeRNG(seed+'|pv');

  if(S.kind==='image'){
    (async()=>{
      try{
        const bmp=await createImageBitmap(S.file);
        // dimensiones destino
        const fitW=Math.min(960,bmp.width), fitH=Math.min(540,bmp.height);
        const c=document.createElement('canvas'); c.width=fitW; c.height=fitH; const ctx=c.getContext('2d',{alpha:false});
        // dibuja base (sin A/B salvo que lo pidas)
        ctx.save(); if(S.mirror){ctx.translate(fitW,0);ctx.scale(-1,1);}
        ctx.drawImage(bmp,0,0,fitW,fitH); ctx.restore();
        // preview de invisibles (ligero)
        drawInvisible(ctx,fitW,fitH,R0,true);
        // preview A/B opcional (coste bajo: aplica solo once)
        if(E.abPreview.checked&&E.abEnable.checked){ ctx.globalCompositeOperation='soft-light'; ctx.fillStyle='rgba(0,0,0,.06)'; ctx.fillRect(0,0,fitW,fitH); }
        // subs (no aplica a imagen)
        E.preview.appendChild(c);
      }catch(e){E.preview.innerHTML='<div class="small">No se pudo previsualizar la imagen.</div>';}
    })();
  }else{
    const box=document.createElement('div'); box.style.position='relative'; box.style.display='inline-block'; E.preview.appendChild(box);
    const v=document.createElement('video'); v.src=S.url; v.controls=true; v.muted=true; v.playsInline=true; box.appendChild(v);

    const drawOverlay= throttle(()=>{
      const oc = box.querySelector('canvas#ov') || (()=>{const k=document.createElement('canvas');k.id='ov';k.style.position='absolute';k.style.left=0;k.style.top=0;box.appendChild(k);return k})();
      oc.width=v.clientWidth; oc.height=v.clientHeight;
      const ctx=oc.getContext('2d'); ctx.clearRect(0,0,oc.width,oc.height);
      drawInvisible(ctx,oc.width,oc.height,R0,true);
      if(E.abPreview.checked&&E.abEnable.checked){ ctx.fillStyle='rgba(0,0,0,.06)'; ctx.fillRect(0,0,oc.width,oc.height); }
      if(E.subsEnable.checked && S.subs.length) drawSubs(ctx,oc.width,oc.height,v.currentTime,S.subs,{size:parseInt(E.subsSize.value||'24',10),bg:E.subsBg.checked});
    }, S.perf?120:60); // ms

    const pump=()=>{drawOverlay(); S.previewTimer=requestAnimationFrame(pump);};
    on(v,'loadedmetadata',()=>{pump();});
    if(v.readyState>=1) pump();
  }
}

// ---------- EXPORTACI√ìN (misma calidad, UI no se congela)
on($('download'),'click',async()=>{
  if(!S.file) return;
  const base=(E.zip.value||'variaciones_ads').replace(/[^a-z0-9._-]/gi,'_').toLowerCase();
  const seed=(E.seed.value||S.seed||genSeed());
  S.abort=false; E.cancel.disabled=false; setProgress(0); E.download.disabled=true;

  const zip=new JSZip();
  try{
    if(S.kind==='image'){
      const bmp=await createImageBitmap(S.file);
      const N=Math.max(1,Math.min(10,parseInt(E.count.value||'1',10)));
      for(let i=1;i<=N;i++){
        const R=makeRNG(seed+'|img|'+i);
        const w=Math.min(2000,bmp.width),h=Math.min(2000,bmp.height*bmp.width>0?bmp.height:2000);
        const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d',{alpha:false});
        ctx.save(); if(S.mirror){ctx.translate(w,0);ctx.scale(-1,1);} ctx.drawImage(bmp,0,0,w,h); ctx.restore();
        if(E.abEnable.checked) drawABExtra(ctx,w,h,R,null,E.abIntensity.value);
        drawInvisible(ctx,w,h,R,false);
        const blob=await new Promise(r=>c.toBlob(r,'image/png',0.95)); zip.file(`${base}_img_${i}.png`,blob,{binary:true});
        setProgress(i*100/N); if(S.abort) break;
      }
    }else{
      const info=await getMeta(S.url);
      const wantBoth=E.both.checked;
      const mp4='video/mp4;codecs=h264';
      const webm=(MediaRecorder.isTypeSupported('video/webm;codecs=vp9')&&'video/webm;codecs=vp9')||(MediaRecorder.isTypeSupported('video/webm;codecs=vp8')&&'video/webm;codecs=vp8')||(MediaRecorder.isTypeSupported('video/webm')&&'video/webm');
      const targets=[]; if(wantBoth){ if(MediaRecorder.isTypeSupported(mp4)) targets.push({ext:'mp4',mime:mp4}); if(webm) targets.push({ext:'webm',mime:webm}); }
      else{ const sel=E.format.value; const ok=MediaRecorder.isTypeSupported(sel); const mime=ok?sel:(sel.includes('mp4')?webm:mp4); targets.push({ext:mime.includes('mp4')?'mp4':'webm',mime}); }

      const segs=parseSegments(E.segments.value, info.duration);
      for(const t of targets){
        const R=makeRNG(seed+'|vid|'+(E.abPerFmt.checked?t.ext:'same'));
        const c=document.createElement('canvas'); c.width=info.width; c.height=info.height; const ctx=c.getContext('2d',{alpha:false});
        const stream=c.captureStream(30);
        try{ const vs=document.createElement('video'); vs.src=S.url; await vs.play(); const aud=vs.captureStream().getAudioTracks()[0]; if(aud) stream.addTrack(aud);}catch{}
        const chunks=[]; const rec=new MediaRecorder(stream,{mimeType:t.mime,videoBitsPerSecond:8_000_000}); rec.ondataavailable=e=>{if(e.data.size)chunks.push(e.data);};

        const v=document.createElement('video'); v.src=S.url; v.muted=true; v.playsInline=true; await new Promise(r=>{v.onloadedmetadata=r;});
        await seek(v, segs.length?segs[0].start : (E.durFull.checked?0: clamp((info.duration-(+E.sec.value||12)),0,info.duration-1) ));
        await v.play(); rec.start(200);

        let plan = segs.length?segs : (E.durFull.checked?[{start:0,end:info.duration}] : [{start:v.currentTime,end:Math.min(info.duration,v.currentTime+ (+E.sec.value||12))}]);
        let idx=0;

        const loop=()=>{
          if(S.abort){ try{v.pause();}catch{} if(rec.state!=='inactive')rec.stop(); return; }
          if(v.paused||v.ended) return;
          ctx.drawImage(v,0,0,c.width,c.height);
          if(E.abEnable.checked) drawABExtra(ctx,c.width,c.height,R,null,E.abIntensity.value);
          drawInvisible(ctx,c.width,c.height,R,false);
          if(E.subsEnable.checked && S.subs.length) drawSubs(ctx,c.width,c.height,v.currentTime,S.subs,{size:+E.subsSize.value||24,bg:E.subsBg.checked});
          const total=plan.reduce((a,p)=>a+(p.end-p.start),0);
          const done=plan.slice(0,idx).reduce((a,p)=>a+(p.end-p.start),0)+(v.currentTime-plan[idx].start);
          setProgress(100*Math.min(1,done/Math.max(0.001,total)));
          if(v.currentTime>=plan[idx].end-0.02){ idx++; if(idx>=plan.length){v.pause(); rec.stop(); return;}
            seek(v,plan[idx].start).then(()=>requestAnimationFrame(loop)); return; }
          requestAnimationFrame(loop);
        };
        loop();

        await new Promise(r=>rec.onstop=()=>r());
        const blob=new Blob(chunks,{type:rec.mimeType}); zip.file(`${base}_video_1.${t.ext}`,blob,{binary:true});
      }
      setProgress(100);
    }

    if(!S.abort){
      const blob=await zip.generateAsync({type:'blob'}); download(blob,`${base}.zip`);
    }
  }catch(err){ console.error(err); alert('Exportaci√≥n fall√≥. Prueba Chrome/Edge y mant√©n esta pesta√±a activa.'); }
  finally{ E.download.disabled=false; E.cancel.disabled=true; setTimeout(()=>setProgress(0),600); S.abort=false; }
});
on(E.cancel,'click',()=>{S.abort=true;});

// ---------- dibujo ‚Äúinvisible‚Äù (previewLight: true reduce costes)
function drawInvisible(ctx,w,h,R,previewLight){
  // borde sutil
  if(E.optBorder.checked){const s=Math.max(1,Math.round(Math.min(w,h)*(previewLight?0.003:0.0045)));ctx.save();ctx.lineWidth=s;ctx.strokeStyle='rgba(255,255,255,0.14)';ctx.strokeRect(s/2,s/2,w-s,h-s);ctx.restore();}
  // borde multicolor
  if(E.optBorderMulti.checked && !previewLight){const s=Math.max(1,Math.round(Math.min(w,h)*0.0055));const c=['rgba(255,80,80,.14)','rgba(80,200,255,.14)','rgba(120,255,120,.14)','rgba(255,220,120,.14)'];ctx.save();ctx.lineWidth=s;
    ctx.strokeStyle=c[0];ctx.beginPath();ctx.moveTo(s/2,s/2);ctx.lineTo(w-s/2,s/2);ctx.stroke();
    ctx.strokeStyle=c[1];ctx.beginPath();ctx.moveTo(w-s/2,s/2);ctx.lineTo(w-s/2,h-s/2);ctx.stroke();
    ctx.strokeStyle=c[2];ctx.beginPath();ctx.moveTo(w-s/2,h-s/2);ctx.lineTo(s/2,h-s/2);ctx.stroke();
    ctx.strokeStyle=c[3];ctx.beginPath();ctx.moveTo(s/2,h-s/2);ctx.lineTo(s/2,s/2);ctx.stroke();ctx.restore();}
  // figuras
  if(E.optShapes.checked){const n=previewLight?2:(3+Math.floor(R()*3));for(let i=0;i<n;i++){const s=Math.min(w,h)*(0.012+R()*0.014),x=(R()*(w-2*s))+s,y=(R()*(h-2*s))+s;ctx.save();ctx.globalAlpha=0.004+R()*0.004;ctx.translate(x,y);ctx.rotate((R()*14-7)*Math.PI/180);ctx.fillStyle='hsl('+Math.floor(R()*360)+',60%,65%)';const t=R();if(t<.34){ctx.beginPath();ctx.arc(0,0,s*0.4,0,6.283);ctx.fill();}else if(t<.67){roundRect(ctx,-s*0.45,-s*0.25,s*0.9,s*0.5,s*0.12);ctx.fill();}else{ctx.beginPath();ctx.moveTo(-s*0.35,s*0.35);ctx.lineTo(0,-s*0.35);ctx.lineTo(s*0.35,s*0.35);ctx.closePath();ctx.fill();}ctx.restore();}}
  // franjas
  if(E.optStripes.checked && !previewLight){const a=(R()*60-30)*Math.PI/180;const sw=Math.min(w,h)*(0.004+R()*0.005),gap=sw*(3.5+R()*2),len=Math.sqrt(w*w+h*h)+sw*2;ctx.save();ctx.translate(w/2,h/2);ctx.rotate(a);ctx.globalCompositeOperation='soft-light';ctx.fillStyle='rgba(255,255,255,0.009)';for(let x=-len;x<=len;x+=gap)ctx.fillRect(x,-len,sw,len*2);ctx.restore();}
  // marca de agua
  if(E.optWM.checked && S.logo){const m=Math.min(w,h)*0.28;const r=Math.min(m/Math.max(S.logo.width,S.logo.height),1);const lw=S.logo.width*r,lh=S.logo.height*r;ctx.save();ctx.globalAlpha=0.006+R()*0.006;ctx.drawImage(S.logo,(w-lw)/2,(h-lh)/2,lw,lh);ctx.restore();}
}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
function drawABExtra(ctx,w,h,R,logo,inten){
  // filtro suave seg√∫n intensidad (aplica como overlay)
  const a=inten==='high'?0.18:inten==='mid'?0.12:0.08; ctx.save(); const g=ctx.createRadialGradient(w/2,h/2,Math.min(w,h)*0.3,w/2,h/2,Math.max(w,h)*0.9);
  g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,'+a+')'); ctx.fillStyle=g; ctx.fillRect(0,0,w,h); ctx.restore();
}
function drawSubs(ctx,w,h,t,cues,opt){
  const active=cues.find(c=>t>=c.start && t<c.end); if(!active) return;
  const pad=Math.round(Math.min(w,h)*0.03), f=clamp(opt.size||24,12,48); ctx.save(); ctx.font=`700 ${f}px system-ui,-apple-system,Segoe UI,Roboto,Arial`; ctx.textBaseline='bottom';
  const lines=active.text.replace(/\r/g,'').split('\n'); const lh=Math.round(f*1.25); const mw=w-pad*2;
  const ms=txt=>ctx.measureText(txt).width; const wrap=[]; for(const ln of lines){const words=ln.split(' ');let line='';for(const wd of words){const test=line?(line+' '+wd):wd;if(ms(test)>mw){if(line)wrap.push(line);line=wd;}else line=test;}if(line)wrap.push(line);}
  const boxW=Math.min(mw, Math.max(...wrap.map(ms))), boxH=lh*wrap.length; const x=(w-boxW)/2, y=h-pad;
  if(opt.bg){ctx.fillStyle='rgba(0,0,0,.45)';roundRect(ctx,x-pad*0.3,y-boxH-pad*0.2,boxW+pad*0.6,boxH+pad*0.2,Math.round(f*0.35)); ctx.fill();}
  ctx.lineWidth=Math.max(2,Math.round(f*0.08)); ctx.strokeStyle='rgba(0,0,0,.6)'; ctx.fillStyle='#fff';
  wrap.forEach((ln,i)=>{const tx=Math.round(w/2 - ms(ln)/2), ty=Math.round(y - (wrap.length-1-i)*lh); ctx.strokeText(ln,tx,ty); ctx.fillText(ln,tx,ty);});
  ctx.restore();
}

// ---------- helpers video
function getMeta(url){return new Promise((res,rej)=>{const v=document.createElement('video');v.src=url;v.onloadedmetadata=()=>res({width:v.videoWidth,height:v.videoHeight,duration:v.duration});v.onerror=rej;});}
function seek(v,t){return new Promise(r=>{try{v.currentTime=t;}catch{} v.onseeked=r; v.onloadeddata&&r();});}
function parseSegments(s,dur){ if(!s) return []; return s.split(',').map(p=>p.trim()).map(r=>{const m=r.match(/^(\d+(?:\.\d+)?)\s*-\s*(\d+(?:\.\d+)?)$/);if(!m)return null;const a=+m[1],b=+m[2];if(b>a && a<dur)return{start:clamp(a,0,dur),end:clamp(b,0,dur)};return null;}).filter(Boolean);}

// ---------- notas
function updateFmtNote(){ const mp4OK=MediaRecorder.isTypeSupported('video/mp4;codecs=h264'); const webmOK=MediaRecorder.isTypeSupported('video/webm;codecs=vp9')||MediaRecorder.isTypeSupported('video/webm;codecs=vp8')||MediaRecorder.isTypeSupported('video/webm'); E.fmtNote.textContent=`Soporte ‚Üí MP4:${mp4OK?'‚úî':'‚úñ'} / WebM:${webmOK?'‚úî':'‚úñ'}`; }

// init
setEnabled(false);
})();
</script>
</body>
</html>
