<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Editor de Singularidad para ADS</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
:root{--bg1:#0a0f1a;--bg2:#0b1320;--card:#0e1626;--stroke:#1c2740;--fg:#e9f0ff;--muted:#a9b8d6;--primary:#3b82f6}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--fg);
background:radial-gradient(1200px 800px at 15% 10%,rgba(59,130,246,.08),transparent 60%),linear-gradient(180deg,var(--bg1),var(--bg2));
min-height:100vh;display:flex;align-items:center;justify-content:center;padding:34px;-webkit-font-smoothing:antialiased}
.app{width:100%;max-width:1120px;background:var(--card);border:1px solid var(--stroke);border-radius:20px;padding:26px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
.header{display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:10px}
h1{margin:0;font-size:28px;font-weight:800;letter-spacing:.1px;text-align:center}
.sub{color:var(--muted);font-size:14px;text-align:center}
.desc{margin-top:8px;color:#b8c6e8;font-size:13.5px;text-align:center}
.grid{display:grid;grid-template-columns:1.12fr .88fr;gap:24px;margin-top:12px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.drop,.drop-mini{border:2px dashed var(--stroke);border-radius:14px;display:flex;align-items:center;justify-content:center;text-align:center;background:#0a1324;cursor:pointer;transition:.15s}
.drop{min-height:200px;padding:22px;margin-bottom:12px}.drop-mini{min-height:84px;padding:12px}
.drop:hover,.drop-mini:hover{border-color:#2a3a64}.drop.dragover,.drop-mini.dragover{border-color:var(--primary)}
.hidden{display:none!important}.visually-hidden{position:absolute!important;width:1px;height:1px;clip-path:inset(50%)}
.preview{position:relative;border:1px solid var(--stroke);border-radius:12px;background:#0b1426;padding:18px;min-height:320px;display:flex;align-items:center;justify-content:center;overflow:hidden}
video,canvas{max-width:100%;max-height:520px;border-radius:10px;image-rendering:crisp-edges}
.overlay{position:absolute;inset:0;pointer-events:none}
.field{background:#0b162e;border:1px solid #21345e;padding:14px 12px;border-radius:12px;color:var(--fg);display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:14px}
.btn{appearance:none;border:1px solid #203055;background:#101a32;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;font-size:14px}
.btn:hover{border-color:#2a3b6b;background:#0e1830}.btn.primaria{background:var(--primary);border-color:#2e6fe0;color:#0b1220}
.help{font-size:12.5px;color:#a9b8d6}.filename{font-size:12.5px;color:#9fb7ff}
.progress{height:10px;background:#0a1428;border:1px solid #1c2f55;border-radius:999px;overflow:hidden;margin-top:12px}
.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--primary),#67a5ff);transition:width .2s}
.toolbar{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
input[type="text"],input[type="number"],select,textarea{background:#0b162e;border:1px solid #21345e;color:#e9f0ff;padding:10px 12px;border-radius:10px;outline:none}
textarea{min-height:110px;width:100%}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #21345e;padding:6px 10px;border-radius:999px;font-size:12.5px}
.hr{height:1px;background:#182b52;margin:8px 0 2px}

/* Job list (progreso por video) */
.jobs{margin-top:10px;display:flex;flex-direction:column;gap:10px}
.job{background:#0b162e;border:1px solid #21345e;border-radius:12px;padding:10px 12px}
.job .title{font-size:12.5px;color:#cfe0ff;margin-bottom:6px}
.job .progress{margin-top:6px}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <h1>Editor de Singularidad para ADS</h1>
    <div class="sub">Variaciones <b>sutiles invisibles</b> + A/B sutil. PNG y MP4/WebM en tu navegador.</div>
    <div class="desc">Prop√≥sito: reducir la repetici√≥n entre anuncios, no evadir revisiones.</div>
  </div>

  <div class="grid">
    <!-- IZQUIERDA -->
    <div>
      <div id="drop" class="drop" tabindex="0" role="button" aria-label="Subir archivo">
        <div>
          <div style="font-weight:800;font-size:16px;margin-bottom:6px">Haz clic o suelta aqu√≠ tu imagen/video</div>
          <div class="help">Formatos: JPG/PNG/GIF/WEBP o MP4 (‚â§ 15MB)</div>
        </div>
      </div>
      <input id="file" class="visually-hidden" type="file" accept="image/png,image/jpeg,image/gif,image/webp,video/mp4"/>

      <div id="fileInfo" class="field hidden" style="justify-content:flex-start;gap:14px">
        <span id="fileName" class="filename"></span>
        <button id="changeBtn" class="btn" type="button">Cambiar archivo</button>
      </div>

      <div id="preview" class="preview"><div class="help">Tu vista previa aparecer√° aqu√≠</div></div>

      <div class="toolbar">
        <button id="mirrorBtn" class="btn" disabled type="button">Espejo ‚Üî</button>
        <button id="clearBtn" class="btn" disabled type="button">Limpiar</button>
      </div>
    </div>

    <!-- DERECHA -->
    <div>
      <div class="field">
        <label for="count"><b>Variaciones (imagen o Video)</b></label>
        <input id="count" type="number" min="1" max="10" value="6" style="width:72px;text-align:center"/>
      </div>

      <div id="countHelp" class="help" style="margin:-8px 0 10px 2px;display:none">
        Para <b>video</b> se descarga <b>1 variaci√≥n por job</b>. Marca abajo cu√°ntos jobs por formato.
      </div>

      <div class="field">
        <label for="zipname"><b>Nombre del ZIP</b></label>
        <input id="zipname" type="text" placeholder="mi_campa√±a_ads" value="variaciones_ads"/>
      </div>

      <div class="field">
        <label for="seed"><b>Semilla</b></label>
        <div class="row" style="flex:1">
          <input id="seed" type="text" placeholder="vac√≠o = aleatoria" style="flex:1"/>
          <button id="seedRnd" class="btn" type="button" title="Generar semilla">üé≤</button>
        </div>
        <span class="help">Fija una semilla para reproducibilidad (incluye A/B y ambos formatos).</span>
      </div>

      <!-- OPCIONES VIDEO -->
      <div class="field" id="videoOpts" style="flex-direction:column;align-items:flex-start;display:none">
        <div class="row">
          <b>Duraci√≥n</b>
          <label class="row"><input type="radio" name="dur" id="durFull" checked/> Completa</label>
          <label class="row"><input type="radio" name="dur" id="durClip"/> Recortar a
            <input id="sec" type="number" min="3" max="120" value="12" style="width:70px;margin-left:6px;text-align:center"/> s
          </label>
          <label class="row"><input type="checkbox" id="randStart"/> inicio aleatorio</label>
        </div>

        <div class="row" style="margin-top:8px;width:100%">
          <b>Segmentos</b>
          <input id="segments" class="grow" type="text" placeholder="opcional: ej 0-3,6-10,12.5-15"/>
        </div>

        <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:12px">
          <b>Formato</b>
          <select id="format" disabled>
            <option>Siempre MP4 + WebM</option>
          </select>
          <label class="row"><b>Videos por formato</b>
            <input id="vidCount" type="number" min="1" max="3" value="2" style="width:64px;text-align:center"/>
          </label>
          <label class="row"><input id="hqQuality" type="checkbox"/> Alta calidad (1080p / 30fps / 8Mbps)</label>
          <label class="row"><input id="noCrop" type="checkbox" checked/> No recortar (frame completo)</label>
          <label class="row"><input id="keepRes" type="checkbox" checked/> Mantener resoluci√≥n original</label>
        </div>
        <span id="formatNote" class="help"></span>
        <span id="bothNote" class="help">Siempre intentamos exportar MP4 y WebM (si MP4 no est√° soportado se exporta WebM).</span>
      </div>

      <!-- INVISIBLES -->
      <div class="field" style="flex-direction:column;align-items:flex-start">
        <b>Variaciones sutiles (invisibles)</b>
        <label class="row"><input id="optBorder" type="checkbox" checked/> Borde color sutil</label>
        <label class="row"><input id="optBorderMulti" type="checkbox"/> Borde multicolor sutil</label>
        <label class="row"><input id="optShapes" type="checkbox" checked/> Figuras casi invisibles</label>
        <label class="row"><input id="optStripes" type="checkbox" checked/> Franjas casi invisibles</label>
        <label class="row"><input id="optCenterWM" type="checkbox" checked/> Marca de agua centrada (logo)</label>
        <div class="hr"></div>
        <label class="row"><input id="optInspect" type="checkbox"/> Visualizar gu√≠as (solo preview, no se exporta)</label>
      </div>

      <!-- A/B SUTIL -->
      <div class="field" style="flex-direction:column;align-items:flex-start">
        <div class="row" style="justify-content:space-between;width:100%">
          <b>A/B sutil (sin textos)</b>
          <div class="row" style="gap:12px">
            <label class="row"><input id="abPreview" type="checkbox"/> Previsualizar</label>
            <label class="row"><input id="abEnable" type="checkbox" checked/> Activar</label>
            <label class="row"><input id="perfLite" type="checkbox" checked/> Modo rendimiento</label>
            <label class="row"><input id="noFlicker" type="checkbox" checked/> Anti-flicker</label>
          </div>
        </div>
        <div class="hr"></div>
        <div class="row" style="width:100%">
          <div style="flex:1">
            <div class="help" style="margin-bottom:6px">Relaciones de aspecto</div>
            <div class="chips">
              <label class="chip"><input id="arOrig" type="checkbox" checked/> Original</label>
              <label class="chip"><input id="ar11"   type="checkbox" checked/> 1:1</label>
              <label class="chip"><input id="ar45"   type="checkbox" checked/> 4:5</label>
              <label class="chip"><input id="ar916"  type="checkbox"/> 9:16</label>
              <label class="chip"><input id="ar169"  type="checkbox"/> 16:9</label>
            </div>
          </div>
          <div>
            <label><b>Intensidad look</b></label>
            <select id="abIntensity">
              <option value="low" selected>Suave</option>
              <option value="mid">Media</option>
              <option value="high">Alta</option>
            </select>
          </div>
        </div>
        <div class="row" style="width:100%">
          <div style="min-width:250px">
            <label><b>Extra sutil</b></label>
            <select id="abExtra">
              <option value="none">Ninguno</option>
              <option value="vignette-soft" selected>Vi√±eta muy suave</option>
              <option value="corner-shadows">Sombras de esquinas</option>
              <option value="rounded-soft">Esquinas redondeadas suaves</option>
              <option value="grain-light">Grano muy fino</option>
              <option value="tint-hue">Tinte leve</option>
              <option value="dot-grid">Patr√≥n de puntos finos</option>
              <option value="logo-corner">Logo en esquina (si subes logo)</option>
            </select>
          </div>
          <label class="row"><input id="abExtraRandom" type="checkbox"/> Aleatorio por variaci√≥n</label>
        </div>
      </div>

      <!-- SUBT√çTULOS -->
      <div class="field" style="flex-direction:column;align-items:flex-start">
        <div class="row" style="justify-content:space-between;width:100%">
          <b>Subt√≠tulos</b>
          <label class="row"><input id="subsEnable" type="checkbox"/> Agregar subt√≠tulos</label>
        </div>
        <div id="subsBox" class="hidden" style="width:100%">
          <div class="row">
            <button id="subsLoad" class="btn" type="button">Cargar SRT/VTT</button>
            <input id="subsFile" class="visually-hidden" type="file" accept=".srt,.vtt,.txt"/>
            <button id="subsPaste" class="btn" type="button">Pegar texto</button>
            <button id="subsClear" class="btn" type="button">Quitar</button>
          </div>
          <textarea id="subsText" class="hidden" placeholder="Pega SRT/VTT o una frase por l√≠nea"></textarea>
          <div class="row">
            <label class="row"><input id="subsAuto" type="checkbox"/> Autogenerar</label>
            <label class="row">Duraci√≥n <input id="subsDur" type="number" min="1" max="10" value="2" style="width:64px"/></label>
            <label class="row">Tama√±o <input id="subsSize" type="number" min="12" max="48" value="24" style="width:70px"/></label>
            <label class="row"><input id="subsBg" type="checkbox" checked/> Fondo</label>
          </div>
        </div>
      </div>

      <!-- LOGO -->
      <div class="field" style="flex-direction:column;align-items:flex-start">
        <div class="help" style="margin-bottom:8px">Logo (PNG/JPG) para marca de agua centrada y ‚Äúlogo en esquina‚Äù.</div>
        <div id="dropLogo" class="drop-mini" tabindex="0" role="button"><b>Arrastra tu logo</b> o haz clic</div>
        <input id="logoFile" class="visually-hidden" type="file" accept="image/png,image/jpeg"/>
        <div id="logoInfo" class="filename hidden"></div>
        <div class="row" style="margin-top:6px"><button id="clearLogo" class="btn" type="button">Quitar logo</button></div>
      </div>

      <div class="help">Salida im√°genes: PNG. V√≠deo: MP4 y WebM (si el navegador soporta MP4). Todo 100% en tu navegador.</div>

      <!-- progreso general -->
      <div class="progress"><div id="bar" class="bar"></div></div>
      <!-- progreso por job -->
      <div id="jobs" class="jobs"></div>

      <div class="row" style="justify-content:flex-end;margin-top:14px">
        <button id="cancelBtn" class="btn" type="button" disabled>Cancelar</button>
        <button id="downloadBtn" class="btn primaria" disabled type="button">Descargar variaciones (.zip)</button>
      </div>
    </div>
  </div>
</div>

<script>
(()=>{ const $=id=>document.getElementById(id);

/* ------------- refs UI ------------- */
const els={
  drop:$('drop'),file:$('file'),fileInfo:$('fileInfo'),fileName:$('fileName'),changeBtn:$('changeBtn'),
  preview:$('preview'),mirrorBtn:$('mirrorBtn'),clearBtn:$('clearBtn'),
  count:$('count'),countHelp:$('countHelp'),zipname:$('zipname'),
  seed:$('seed'),seedRnd:$('seedRnd'),downloadBtn:$('downloadBtn'),cancelBtn:$('cancelBtn'),bar:$('bar'),jobs:$('jobs'),
  optBorder:$('optBorder'),optBorderMulti:$('optBorderMulti'),optShapes:$('optShapes'),optStripes:$('optStripes'),optCenterWM:$('optCenterWM'),optInspect:$('optInspect'),
  dropLogo:$('dropLogo'),logoFile:$('logoFile'),logoInfo:$('logoInfo'),clearLogo:$('clearLogo'),
  videoOpts:$('videoOpts'),durFull:$('durFull'),durClip:$('durClip'),sec:$('sec'),randStart:$('randStart'),segments:$('segments'),
  format:$('format'),hqQuality:$('hqQuality'),noCrop:$('noCrop'),keepRes:$('keepRes'),vidCount:$('vidCount'),
  abEnable:$('abEnable'),abPreview:$('abPreview'),abIntensity:$('abIntensity'),arOrig:$('arOrig'),ar11:$('ar11'),ar45:$('ar45'),ar916:$('ar916'),ar169:$('ar169'),
  abExtra:$('abExtra'),abExtraRandom:$('abExtraRandom'), perfLite:$('perfLite'), noFlicker:$('noFlicker'),
  subsEnable:$('subsEnable'),subsBox:$('subsBox'),subsLoad:$('subsLoad'),subsFile:$('subsFile'),subsPaste:$('subsPaste'),subsText:$('subsText'),subsClear:$('subsClear'),
  subsAuto:$('subsAuto'),subsDur:$('subsDur'),subsSize:$('subsSize'),subsBg:$('subsBg'),
  formatNote:$('formatNote'),bothNote:$('bothNote')
};

const MAX_VIDEO=15*1024*1024;
const state={file:null,kind:null,url:null,logo:null,mirror:false,abort:false,previewSeed:null,
             pv:{wrap:null,video:null,ovStatic:null,ovDyn:null,cleanup:()=>{}},subs:[]};

/* ---------- helpers de UI ---------- */
const throttle=(fn,ms)=>{let t=0;return(...a)=>{const n=performance.now();if(n-t>=ms){t=n;fn(...a);}}};
function setEnabled(v){ els.downloadBtn.disabled=!v; els.clearBtn.disabled=!v; els.mirrorBtn.disabled=!v; }
function clearAll(){
  if(state.url) URL.revokeObjectURL(state.url);
  if(state.pv.cleanup) state.pv.cleanup();
  Object.assign(state,{file:null,kind:null,url:null,mirror:false,abort:false,previewSeed:null,subs:[],pv:{wrap:null,video:null,ovStatic:null,ovDyn:null,cleanup:()=>{}}});
  els.preview.innerHTML='<div class="help">Tu vista previa aparecer√° aqu√≠</div>';
  els.mirrorBtn.textContent='Espejo ‚Üî'; els.fileInfo.classList.add('hidden'); els.drop.classList.remove('hidden');
  els.count.disabled=false; els.countHelp.style.display='none'; els.videoOpts.style.display='none'; setEnabled(false);
  els.jobs.innerHTML=''; setProgress(0);
}
function setProgress(p){ els.bar.style.width=Math.max(0,Math.min(100,p))+'%'; }

/* ---------- drop / file ---------- */
els.drop.addEventListener('click',()=>{ els.file.value=''; els.file.click(); });
els.drop.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); els.file.value=''; els.file.click(); }});
['dragenter','dragover'].forEach(ev=>els.drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();els.drop.classList.add('dragover');}));
['dragleave','drop'].forEach(ev=>els.drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();els.drop.classList.remove('dragover');}));
els.drop.addEventListener('drop',e=>{ const f=e.dataTransfer.files?.[0]; if(f) handleMain(f); });
els.file.addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f) handleMain(f); });
els.changeBtn.addEventListener('click',()=>{ els.file.value=''; els.file.click(); });

/* ---------- logo ---------- */
['click','keydown'].forEach(ev=>els.dropLogo.addEventListener(ev,e=>{ if(ev==='keydown' && !(e.key==='Enter'||e.key===' ')) return; e.preventDefault(); els.logoFile.value=''; els.logoFile.click(); }));
els.logoFile.addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; if(!/^image\/(png|jpeg)$/.test(f.type)) return alert('Logo: PNG/JPG'); const u=URL.createObjectURL(f); const img=new Image(); img.onload=()=>{ state.logo=img; URL.revokeObjectURL(u); els.logoInfo.textContent='Logo: '+f.name; els.logoInfo.classList.remove('hidden'); renderPreview(); }; img.src=u; });
els.clearLogo.addEventListener('click',()=>{ state.logo=null; els.logoInfo.classList.add('hidden'); els.logoFile.value=''; renderPreview(); });

/* ---------- subt√≠tulos ---------- */
els.subsEnable.addEventListener('change',()=>{ els.subsBox.classList.toggle('hidden',!els.subsEnable.checked); renderPreview(); });
els.subsLoad.addEventListener('click',()=>els.subsFile.click());
els.subsFile.addEventListener('change',async e=>{ const f=e.target.files?.[0]; if(!f)return; const txt=await f.text(); state.subs=parseSubs(txt); renderPreview(); });
els.subsPaste.addEventListener('click',()=>els.subsText.classList.toggle('hidden'));
els.subsText.addEventListener('input',()=>{ if(els.subsAuto.checked) state.subs=autoFromText(els.subsText.value, parseInt(els.subsDur.value||'2',10)); else state.subs=parseSubs(els.subsText.value); renderPreview(); });
els.subsClear.addEventListener('click',()=>{ state.subs=[]; els.subsText.value=''; renderPreview(); });

/* ---------- opciones que refrescan preview ---------- */
[
 'abEnable','abPreview','abIntensity','arOrig','ar11','ar45','ar916','ar169','abExtra','abExtraRandom',
 'optBorder','optBorderMulti','optShapes','optStripes','optCenterWM','optInspect',
 'durFull','durClip','sec','randStart','segments',
 'subsEnable','subsAuto','subsDur','subsSize','subsBg','perfLite','noFlicker','hqQuality','noCrop','keepRes'
].forEach(id=>{ (document.getElementById(id)||{}).addEventListener?.('change',renderPreview); });

els.seedRnd.addEventListener('click',()=>{ els.seed.value=genSeed(); renderPreview(); });
els.mirrorBtn.addEventListener('click',()=>{ if(!state.file) return; state.mirror=!state.mirror; els.mirrorBtn.textContent=state.mirror?'Espejo ACTIVADO ‚Üî':'Espejo ‚Üî'; renderPreview(); });
els.clearBtn.addEventListener('click',clearAll);

/* ---------- manejo archivo ---------- */
async function handleMain(file){
  const isImage=/^image\/(png|jpeg|gif|webp)$/.test(file.type);
  const isVideo=file.type==='video/mp4';
  if(!(isImage||isVideo)) return alert('Formato no soportado.');
  if(isVideo && file.size>MAX_VIDEO) return alert('Video > 15MB.');

  state.file=file; state.kind=isImage?'image':'video';
  if(state.url) URL.revokeObjectURL(state.url); state.url=URL.createObjectURL(file);
  els.fileName.textContent=`${file.name} ‚Ä¢ ${Math.round(file.size/1024)} KB`;
  els.fileInfo.classList.remove('hidden'); els.drop.classList.add('hidden');
  setEnabled(true); state.previewSeed=genSeed();

  if(state.kind==='video'){ els.count.value=1; els.count.disabled=true; els.countHelp.style.display='block'; els.videoOpts.style.display='flex'; }
  else { els.count.disabled=false; els.countHelp.style.display='none'; els.videoOpts.style.display='none'; }

  renderPreview(); updateFormatNote();
}

/* ---------- image loader robusto ---------- */
async function loadBitmap(file){
  try{
    if ('createImageBitmap' in window){
      const bmp = await createImageBitmap(file);
      bmp._w = bmp.width; bmp._h = bmp.height;
      return bmp;
    }
  }catch(e){}
  return await new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>{
      const img = new Image();
      img.crossOrigin='anonymous';
      img.onload = ()=>{ img._w = img.naturalWidth; img._h = img.naturalHeight; resolve(img); };
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
const getW = img => img._w || img.naturalWidth || img.width;
const getH = img => img._h || img.naturalHeight || img.height;

/* ---------- anti-flicker overlay ---------- */
function drawInvisibleStatic(ctx, w, h, seed, options = {}) {
  const R = makeRNG(seed || 'ov');
  const allowStripes = !!options.allowStripes && !els.noFlicker?.checked;

  if (els.optBorder.checked) {
    const size = Math.max(1, Math.round(Math.min(w, h) * (0.003 + 0.0025)));
    ctx.save(); ctx.lineWidth = size; ctx.strokeStyle = 'rgba(255,255,255,0.14)';
    ctx.strokeRect(size/2, size/2, w-size, h-size); ctx.restore();
  }
  if (els.optBorderMulti.checked && !els.noFlicker?.checked) {
    const s = Math.max(1, Math.round(Math.min(w, h) * 0.0055));
    const cols=['rgba(255,80,80,0.14)','rgba(80,200,255,0.14)','rgba(120,255,120,0.14)','rgba(255,220,120,0.14)'];
    ctx.save(); ctx.lineWidth=s;
    ctx.strokeStyle=cols[0]; ctx.beginPath(); ctx.moveTo(s/2,s/2); ctx.lineTo(w-s/2,s/2); ctx.stroke();
    ctx.strokeStyle=cols[1]; ctx.beginPath(); ctx.moveTo(w-s/2,s/2); ctx.lineTo(w-s/2,h-s/2); ctx.stroke();
    ctx.strokeStyle=cols[2]; ctx.beginPath(); ctx.moveTo(w-s/2,h-s/2); ctx.lineTo(s/2,h-s/2); ctx.stroke();
    ctx.strokeStyle=cols[3]; ctx.beginPath(); ctx.moveTo(s/2,h-s/2); ctx.lineTo(s/2,s/2); ctx.stroke();
    ctx.restore();
  }
  if (els.optShapes.checked) {
    const n = 3 + Math.floor(R()*3);
    for (let i=0;i<n;i++){
      const s=Math.min(w,h)*(0.012+R()*0.014);
      const x=(R()*(w-2*s))+s, y=(R()*(h-2*s))+s;
      ctx.save(); ctx.globalAlpha=0.003+R()*0.004; ctx.translate(x,y); ctx.rotate((R()*14-7)*Math.PI/180);
      ctx.fillStyle='hsl('+Math.floor(R()*360)+',60%,65%)';
      const t=R();
      if(t<.34){ ctx.beginPath(); ctx.arc(0,0,s*0.4,0,Math.PI*2); ctx.fill(); }
      else if(t<.67){ roundRect(ctx,-s*0.45,-s*0.25,s*0.9,s*0.5,s*0.12); ctx.fill(); }
      else { ctx.beginPath(); ctx.moveTo(-s*0.35,s*0.35); ctx.lineTo(0,-s*0.35); ctx.lineTo(s*0.35,s*0.35); ctx.closePath(); ctx.fill(); }
      ctx.restore();
    }
  }
  if (els.optStripes.checked && allowStripes) {
    const R2=makeRNG(seed+'|st');
    const a=(R2()*60-30)*Math.PI/180;
    const sw=Math.max(0.5,Math.min(w,h)*(0.004+R2()*0.005));
    const gap=Math.max(1,sw*(3.5+R2()*2));
    const len=Math.sqrt(w*w+h*h)+sw*2;
    ctx.save(); ctx.translate(w/2,h/2); ctx.rotate(a); ctx.globalCompositeOperation='soft-light'; ctx.fillStyle='rgba(255,255,255,0.009)';
    for(let x=-len;x<=len;x+=gap) ctx.fillRect(x,-len,sw,len*2);
    ctx.restore();
  }
  if (els.optCenterWM.checked && state.logo) {
    const m=Math.min(w,h)*0.28;
    const r=Math.min(m/Math.max(state.logo.width,state.logo.height),1);
    const lw=state.logo.width*r, lh=state.logo.height*r;
    ctx.save(); ctx.globalAlpha=0.006+Math.random()*0.002;
    ctx.drawImage(state.logo,Math.round((w-lw)/2),Math.round((h-lh)/2),Math.round(lw),Math.round(lh));
    ctx.restore();
  }
}
function buildOverlayCanvas(w,h,seed){
  const ov=document.createElement('canvas');
  ov.width=Math.max(1,Math.round(w)); ov.height=Math.max(1,Math.round(h));
  const octx=ov.getContext('2d');
  drawInvisibleStatic(octx, ov.width, ov.height, seed, {allowStripes:false});
  if(!els.noFlicker?.checked){
    const R=makeRNG(seed+'|extra');
    drawABExtra(octx, ov.width, ov.height, R, state.logo);
  }
  return ov;
}

/* ---------- PREVIEW ---------- */
function drawGuidesSafe(ctx,w,h,R){
  try{
    if(!ctx||!w||!h||w<=1||h<=1) return;
    if(typeof ctx.setLineDash!=='function'){ ctx.save(); ctx.lineWidth=Math.max(1,Math.round(Math.min(w,h)*0.006)); ctx.strokeStyle='rgba(255,255,0,.65)'; ctx.strokeRect(0.5,0.5,w-1,h-1); ctx.restore(); return; }
    drawGuides(ctx,w,h,R);
  }catch(e){ console.warn('Gu√≠as desactivadas:',e); }
}

function renderPreview(){
  if(!state.file){ els.preview.innerHTML='<div class="help">Tu vista previa aparecer√° aqu√≠</div>'; return; }
  state.pv.cleanup(); els.preview.innerHTML='';
  const seed=(els.seed.value||'').trim() || state.previewSeed; const R=makeRNG(seed);

  if(state.kind==='image'){
    (async()=>{
      try{
        const bmp=await loadBitmap(state.file);
        const showAB=els.abPreview.checked && els.abEnable.checked;
        let ow=getW(bmp), oh=getH(bmp);
        let crop={sx:0,sy:0,sw:ow,sh:oh};
        if(showAB && !els.noCrop.checked){
          const ratio=pickAspect(ow,oh,R); crop=computeCrop(ow,oh,ratio,R);
        }
        const out={w:crop.sw,h:crop.sh};
        const fitC=fit(out.w,out.h,960,540);
        const dpr=window.devicePixelRatio||1;
        const cssW=Math.max(1,Math.round(fitC.w)), cssH=Math.max(1,Math.round(fitC.h));
        const c=document.createElement('canvas'); 
        c.width=Math.max(1,Math.round(cssW*dpr)); c.height=Math.max(1,Math.round(cssH*dpr));
        c.style.width=cssW+'px'; c.style.height=cssH+'px';
        const ctx=c.getContext('2d'); ctx.scale(dpr,dpr); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';

        ctx.save(); if(state.mirror){ctx.translate(cssW,0);ctx.scale(-1,1);} if(showAB) ctx.filter=pickLook(els.abIntensity.value,R);
        ctx.drawImage(bmp, crop.sx,crop.sy,crop.sw,crop.sh, 0,0, cssW,cssH); ctx.restore(); ctx.filter='none';

        const ov=buildOverlayCanvas(cssW,cssH,seed+'|imgpv');
        ctx.drawImage(ov,0,0);
        if(els.optInspect.checked) drawGuidesSafe(ctx,cssW,cssH,R);
        els.preview.appendChild(c);
      }catch(err){
        console.error('Preview imagen',err);
        els.preview.innerHTML='<div class="help">No se pudo dibujar la vista previa. Vuelve a intentarlo o prueba otro archivo.</div>';
      }
    })();
  }else{
    const wrap=document.createElement('div'); wrap.style.position='relative'; wrap.style.display='inline-block'; els.preview.appendChild(wrap);
    const v=document.createElement('video'); v.src=state.url; v.controls=true; v.muted=true; v.playsInline=true; wrap.appendChild(v);
    const ovStatic=document.createElement('canvas'); ovStatic.className='overlay'; wrap.appendChild(ovStatic);
    const ovDyn=document.createElement('canvas'); ovDyn.className='overlay'; wrap.appendChild(ovDyn);

    let ro=null, onTime=null;
    const rebuildStatic=()=>{
      let w=v.clientWidth, h=v.clientHeight;
      if(!w||!h){ const f=fit(v.videoWidth||640,v.videoHeight||360,960,540); w=f.w; h=f.h; }
      ovStatic.width=w; ovStatic.height=h; ovStatic.style.width=w+'px'; ovStatic.style.height=h+'px';
      const octx=ovStatic.getContext('2d'); const R2=makeRNG(seed+'|pv'); octx.clearRect(0,0,w,h);
      const staticOV = buildOverlayCanvas(w,h,seed+'|pv-static');
      octx.drawImage(staticOV,0,0);
      if(els.optInspect.checked) drawGuidesSafe(octx,w,h,R2);
    };
    const updateDyn=throttle(()=>{
      let w=v.clientWidth, h=v.clientHeight;
      if(!w||!h){ const f=fit(v.videoWidth||640,v.videoHeight||360,960,540); w=f.w; h=f.h; }
      ovDyn.width=w; ovDyn.height=h; ovDyn.style.width=w+'px'; ovDyn.style.height=h+'px';
      const dctx=ovDyn.getContext('2d'); dctx.clearRect(0,0,w,h);
      if(els.subsEnable.checked && state.subs.length){ drawSubs(dctx,w,h,v.currentTime,state.subs,{size:+els.subsSize.value||24,bg:els.subsBg.checked}); }
    }, els.perfLite?.checked?120:80);

    const apply=()=>{
      const showAB=els.abPreview.checked && els.abEnable.checked;
      v.style.position='static'; v.style.left='0px'; v.style.top='0px';
      v.style.transform=state.mirror?'scaleX(-1)':'none'; wrap.style.overflow='visible'; v.style.filter='none';

      if(!showAB || els.noCrop.checked){
        v.style.maxWidth='100%'; v.style.maxHeight='520px';
        if(showAB) v.style.filter=pickLook(els.abIntensity.value,makeRNG(seed+'|look') );
        rebuildStatic(); return;
      }

      const R3=makeRNG(seed+'|pv3');
      const ratio=pickAspect(v.videoWidth,v.videoHeight,R3);
      const crop=computeCrop(v.videoWidth,v.videoHeight,ratio,R3);
      const fitC=fit(crop.sw,crop.sh,960,540);
      wrap.style.width=fitC.w+'px'; wrap.style.height=fitC.h+'px'; wrap.style.overflow='hidden';

      const s=Math.min(fitC.w/crop.sw, fitC.h/crop.sh);
      const videoW=Math.round(v.videoWidth*s), videoH=Math.round(v.videoHeight*s);
      const offX=Math.round(-crop.sx*s), offY=Math.round(-crop.sy*s);
      v.style.position='absolute'; v.style.width=videoW+'px'; v.style.height=videoH+'px'; v.style.left=offX+'px'; v.style.top=offY+'px';
      v.style.transform=(state.mirror?'scaleX(-1) ':'')+'translateZ(0)'; v.style.filter=pickLook(els.abIntensity.value,R3);
      rebuildStatic();
    };

    v.addEventListener('loadedmetadata',apply);
    onTime=()=>updateDyn();
    v.addEventListener('timeupdate',onTime);
    ro=new ResizeObserver(()=>{ apply(); updateDyn(); }); ro.observe(wrap);

    state.pv.cleanup=()=>{ try{v.pause();}catch{} v.removeEventListener('timeupdate',onTime); ro&&ro.disconnect(); };
    if(v.readyState>=1) apply();
  }
}

/* ---------- exportar (multi-jobs + barras) ---------- */
els.cancelBtn.addEventListener('click',()=>{ state.abort=true; });
els.downloadBtn.addEventListener('click', doExport);

async function doExport(){
  if(!state.file) return;
  const base=(els.zipname.value||'variaciones_ads').toLowerCase().replace(/[^a-z0-9._-]+/g,'_');
  const seedUI=(els.seed.value||'').trim(); const seedBase=seedUI||genSeed();
  state.abort=false; els.cancelBtn.disabled=false; setProgress(0); els.downloadBtn.disabled=true; els.jobs.innerHTML='';
  const zip=new JSZip();

  try{
    if(state.kind==='image'){
      const bmp=await loadBitmap(state.file);
      const N=Math.max(1,Math.min(10,parseInt(els.count.value||'1',10)));
      const job=createJob(`Im√°genes (${N})`);
      for(let i=1;i<=N;i++){
        const R=makeRNG(seedBase+`|img|${i}`); const showAB=els.abEnable.checked;
        let ow=getW(bmp), oh=getH(bmp); let crop={sx:0,sy:0,sw:ow,sh:oh};
        if(showAB && !els.noCrop.checked){ const ratio=pickAspect(ow,oh,R); crop=computeCrop(ow,oh,ratio,R); }
        const w=crop.sw, h=crop.sh;
        const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
        ctx.save(); if(state.mirror){ctx.translate(w,0);ctx.scale(-1,1);} if(showAB) ctx.filter=pickLook(els.abIntensity.value,R);
        ctx.drawImage(bmp,crop.sx,crop.sy,crop.sw,crop.sh,0,0,w,h); ctx.restore(); ctx.filter='none';
        const ov=buildOverlayCanvas(w,h,seedBase+`|imgov|${i}`); ctx.drawImage(ov,0,0);
        const blob=await new Promise(r=>c.toBlob(r,'image/png',0.95)); zip.file(`${base}_img_${i}.png`,blob,{binary:true});
        job.pct(i*(100/N));
        setProgress((i/N)*100*0.9); // general suave
        if(state.abort) break;
      }
      job.done();
    }else{
      const info=await videoMeta(state.url);
      const targets=getTargetsBoth(); // SIEMPRE intentamos ambos
      const count=Math.max(1,Math.min(3,parseInt(els.vidCount.value||'1',10)));
      const plan=parseSegments(els.segments?.value||'', info.duration);

      const totalJobs=targets.length*count;
      let finished=0;

      for(const t of targets){
        for(let i=1;i<=count;i++){
          const job=createJob(`Video ${t.label.toUpperCase()} ‚Ä¢ variaci√≥n ${i}/${count}`);
          await exportOneVideo({t,idx:i,info,plan,seedBase,baseName:base,zip,job,jobIdx:finished,totalJobs});
          finished++; job.done();
          if(state.abort) break;
        }
        if(state.abort) break;
      }
      setProgress(100);
    }

    if(!state.abort){
      zip.file('manifest.json',JSON.stringify({
        app:'Editor de Singularidad para ADS',
        version:'v33',
        seed:seedBase,
        antiFlicker:!!els.noFlicker?.checked,
        keepRes:!!els.keepRes?.checked,
        noCrop:!!els.noCrop?.checked,
        hq:!!els.hqQuality?.checked,
        note_mp4_supported: MediaRecorder.isTypeSupported('video/mp4;codecs=h264')
      },null,2));
      const zipBlob=await zip.generateAsync({type:'blob'}); download(zipBlob,`${base}.zip`);
    }
  }catch(err){ console.error(err); alert('No se pudo exportar. Usa Chrome/Edge recientes y deja la pesta√±a activa.'); }
  finally{ els.downloadBtn.disabled=false; els.cancelBtn.disabled=true; setTimeout(()=>setProgress(0),900); state.abort=false; }
}

async function exportOneVideo({t,idx,info,plan,seedBase,baseName,zip,job,jobIdx,totalJobs}){
  const R=makeRNG(seedBase+`|vid|${t.label}|${idx}`);
  let crop={sx:0,sy:0,sw:info.width,sh:info.height};
  if(els.abEnable.checked && !els.noCrop.checked){
    const ratio=pickAspect(info.width,info.height,R); crop=computeCrop(info.width,info.height,ratio,R);
  }
  let outW=crop.sw, outH=crop.sh;
  if(!els.keepRes.checked){
    const maxSide = els.hqQuality?.checked ? 1080 : 720;
    const scale = Math.min(1, maxSide/Math.max(outW,outH));
    outW=Math.round(outW*scale); outH=Math.round(outH*scale);
  }

  const v=document.createElement('video'); v.src=state.url; v.muted=true; v.playsInline=true; await new Promise((res,rej)=>{ v.onloadedmetadata=res; v.onerror=rej; });
  const fps = els.hqQuality?.checked ? 30 : 24;
  const bps = els.hqQuality?.checked ? 8_000_000 : 4_000_000;

  const c=document.createElement('canvas'); c.width=outW; c.height=outH; const ctx=c.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
  const stream=c.captureStream(fps); try{ const vs=v.captureStream(); const aud=vs.getAudioTracks(); if(aud&&aud.length) stream.addTrack(aud[0]); }catch{}
  const chunks=[]; const rec=new MediaRecorder(stream,{mimeType:t.mime,videoBitsPerSecond:bps}); rec.ondataavailable=e=>{ if(e.data&&e.data.size) chunks.push(e.data); };

  const overlayStatic = buildOverlayCanvas(outW, outH, seedBase + '|ov|' + t.label + '|' + idx);

  let segments=plan;
  if(!segments.length){
    if(els.durFull.checked){ segments=[{start:0,end:info.duration}]; }
    else {
      const clipS=Math.max(3,parseInt(els.sec.value||'12',10));
      const maxStart=Math.max(0,(info.duration||0)-clipS);
      const start=els.randStart.checked?Math.random()*maxStart:0;
      segments=[{start, end:Math.min(info.duration,start+clipS)}];
    }
  }
  const totDur=segments.reduce((a,s)=>a+(s.end-s.start),0)||1;
  let idxSeg=0;

  await seek(v, segments[0].start);
  await v.play(); rec.start(250);

  const drawFrame=()=>{
    if(state.abort){ try{v.pause();}catch{} if(rec.state!=='inactive') rec.stop(); return; }
    if(v.paused) return;
    ctx.clearRect(0,0,outW,outH);
    ctx.save(); if(state.mirror){ctx.translate(outW,0);ctx.scale(-1,1);} ctx.filter=els.abEnable.checked?pickLook(els.abIntensity.value,R):'none';
    if(els.noCrop.checked){ ctx.drawImage(v,0,0,info.width,info.height,0,0,outW,outH); }
    else { ctx.drawImage(v,crop.sx,crop.sy,crop.sw,crop.sh,0,0,outW,outH); }
    ctx.restore(); ctx.filter='none';

    ctx.drawImage(overlayStatic,0,0);

    if(els.subsEnable.checked && state.subs.length){
      drawSubs(ctx,outW,outH,v.currentTime,state.subs,{size:+els.subsSize.value||24,bg:els.subsBg.checked});
    }

    const done=segments.slice(0,idxSeg).reduce((a,s)=>a+(s.end-s.start),0) + (v.currentTime-segments[idxSeg].start);
    const jobP = Math.max(0,Math.min(100,(done/totDur)*100));
    job.pct(jobP);
    setProgress( ((jobIdx + jobP/100)/totalJobs)*100 );

    if(v.currentTime >= segments[idxSeg].end - 0.02){
      idxSeg++;
      if(idxSeg>=segments.length){ v.pause(); if(rec.state!=='inactive') rec.stop(); return; }
      seek(v,segments[idxSeg].start).then(()=>requestAnimationFrame(drawFrame));
      return;
    }
    requestAnimationFrame(drawFrame);
  };
  drawFrame();

  await new Promise(r=>rec.onstop=()=>r());
  const ext = t.label; // 'mp4' o 'webm'
  const blob=new Blob(chunks,{type:rec.mimeType}); zip.file(`${baseName}_${ext}_${String(idx).padStart(2,'0')}.${ext}`,blob,{binary:true});
}

/* ---------- job UI ---------- */
function createJob(title){
  const box=document.createElement('div'); box.className='job';
  const h=document.createElement('div'); h.className='title'; h.textContent=title;
  const p=document.createElement('div'); p.className='progress';
  const bar=document.createElement('div'); bar.className='bar'; p.appendChild(bar);
  box.appendChild(h); box.appendChild(p); els.jobs.appendChild(box);
  return { pct:(v)=>{ bar.style.width=Math.max(0,Math.min(100,v))+'%'; }, done:()=>{ bar.style.width='100%'; } };
}

/* ---------- looks/gu√≠as/util (igual que v32) ---------- */
function drawABExtra(ctx,w,h,R,logo){
  if (els?.noFlicker?.checked) return;
  let mode=els.abExtra.value; if(els.abExtraRandom.checked){ const opts=['vignette-soft','corner-shadows','rounded-soft','grain-light','tint-hue','dot-grid']; if(logo) opts.push('logo-corner'); mode=opts[Math.floor(R()*opts.length)]; }
  if(mode==='vignette-soft'){ const g=ctx.createRadialGradient(w/2,h/2,Math.min(w,h)*0.25,w/2,h/2,Math.max(w,h)*0.85); g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,0.14)'); ctx.save(); ctx.fillStyle=g; ctx.fillRect(0,0,w,h); ctx.restore(); }
  else if(mode==='corner-shadows'){ const s=Math.min(w,h)*0.22; const draw=(x,y)=>{ const g=ctx.createRadialGradient(x,y,1,x,y,s); g.addColorStop(0,'rgba(0,0,0,0.14)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.save(); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,s,0,2*Math.PI); ctx.fill(); ctx.restore(); }; draw(0,0); draw(w,0); draw(0,h); draw(w,h); }
  else if(mode==='rounded-soft'){ const pad=Math.round(Math.min(w,h)*0.02 + R()*Math.min(w,h)*0.01); const r=Math.round(Math.min(w,h)*(0.06+R()*0.05)); ctx.save(); ctx.strokeStyle='rgba(255,255,255,0.22)'; ctx.lineWidth=Math.max(2,Math.round(Math.min(w,h)*0.008)); roundRect(ctx,pad,pad,w-2*pad,h-2*pad,r); ctx.stroke(); ctx.restore(); }
  else if(mode==='grain-light'){ const nC=document.createElement('canvas'); nC.width=64;nC.height=64; const nctx=nC.getContext('2d'); const img=nctx.createImageData(64,64); for(let i=0;i<img.data.length;i+=4){ const g=128+Math.floor((R()-0.5)*26); img.data[i]=img.data[i+1]=img.data[i+2]=g; img.data[i+3]=7; } nctx.putImageData(img,0,0); const p=ctx.createPattern(nC,'repeat'); ctx.save(); ctx.globalCompositeOperation='soft-light'; ctx.fillStyle=p; ctx.fillRect(0,0,w,h); ctx.restore(); }
  else if(mode==='tint-hue'){ const hue=Math.floor(R()*360); const col=`hsla(${hue},16%,50%,0.06)`; ctx.save(); ctx.fillStyle=col; ctx.fillRect(0,0,w,h); ctx.restore(); }
  else if(mode==='dot-grid'){ const step=Math.round(Math.min(w,h)*(0.04+R()*0.03)); ctx.save(); ctx.fillStyle='rgba(255,255,255,0.03)'; for(let y=step/2;y<h;y+=step) for(let x=step/2;x<w;x+=step) ctx.fillRect(x,y,1,1); ctx.restore(); }
  else if(mode==='logo-corner' && logo){ const s=Math.min(w,h)*0.12; const r=Math.min(s/Math.max(logo.width,logo.height),1); const lw=Math.round(logo.width*r), lh=Math.round(logo.height*r); const pad=Math.round(Math.min(w,h)*0.02); const pos=['tl','tr','br','bl'][Math.floor(R()*4)]; let x=pad,y=pad; if(pos==='tr') x=w-pad-lw; if(pos==='br'){x=w-pad-lw;y=h-pad-lh;} if(pos==='bl') y=h-pad-lh; ctx.save(); ctx.globalAlpha=0.72; ctx.drawImage(logo,x,y,lw,lh); ctx.restore(); }
}
function drawGuides(ctx,w,h,R){ guideBorder(ctx,w,h); if(els.optBorderMulti.checked) guideBorderMulti(ctx,w,h); if(els.optShapes.checked) guideShapes(ctx,w,h,R); if(els.optStripes.checked) guideStripes(ctx,w,h,R); if(els.optCenterWM.checked) guideWM(ctx,w,h); }
function guideBorder(ctx,w,h){ const s=Math.max(1,Math.round(Math.min(w,h)*0.006)); ctx.save(); ctx.lineWidth=s; ctx.strokeStyle='rgba(255,255,0,.65)'; ctx.setLineDash([8,6]); ctx.strokeRect(s/2,s/2,w-s,h-s); ctx.restore(); }
function guideBorderMulti(ctx,w,h){ const s=Math.max(1,Math.round(Math.min(w,h)*0.006)); const cols=['rgba(255,80,80,.8)','rgba(80,200,255,.8)','rgba(120,255,120,.8)','rgba(255,220,120,.8)']; ctx.save(); ctx.lineWidth=s; ctx.setLineDash([10,5]);
  ctx.strokeStyle=cols[0]; ctx.beginPath(); ctx.moveTo(s/2,s/2); ctx.lineTo(w-s/2,s/2); ctx.stroke();
  ctx.strokeStyle=cols[1]; ctx.beginPath(); ctx.moveTo(w-s/2,s/2); ctx.lineTo(w-s/2,h-s/2); ctx.stroke();
  ctx.strokeStyle=cols[2]; ctx.beginPath(); ctx.moveTo(w-s/2,h-s/2); ctx.lineTo(s/2,h-s/2); ctx.stroke();
  ctx.strokeStyle=cols[3]; ctx.beginPath(); ctx.moveTo(s/2,h-s/2); ctx.lineTo(s/2,s/2); ctx.stroke(); ctx.restore();
}
function guideShapes(ctx,w,h,R){ const n=3+Math.floor(R()*3); for(let i=0;i<n;i++){ const s=Math.min(w,h)*(0.012+R()*0.014); const x=(R()*(w-2*s))+s, y=(R()*(h-2*s))+s; ctx.save(); ctx.translate(x,y); ctx.rotate((R()*14-7)*Math.PI/180);
  ctx.globalAlpha=.28; ctx.fillStyle='rgba(0,255,255,.18)'; ctx.strokeStyle='rgba(0,255,255,.85)'; ctx.lineWidth=Math.max(1,s*0.03);
  const t=R(); if(t<.34){ ctx.beginPath(); ctx.arc(0,0,s*0.4,0,Math.PI*2); ctx.fill(); ctx.stroke(); } else if(t<.67){ roundRect(ctx,-s*0.45,-s*0.25,s*0.9,s*0.5,s*0.12); ctx.fill(); ctx.stroke(); } else { ctx.beginPath(); ctx.moveTo(-s*0.35,s*0.35); ctx.lineTo(0,-s*0.35); ctx.lineTo(s*0.35,s*0.35); ctx.closePath(); ctx.fill(); ctx.stroke(); } ctx.restore(); } }
function guideStripes(ctx,w,h,R){ const a=0; const sw=Math.max(0.5,Math.min(w,h)*0.009), gap=Math.max(1,sw*4.5), len=Math.sqrt(w*w+h*h)+sw*2; ctx.save(); ctx.translate(w/2,h/2); ctx.rotate(a); ctx.fillStyle='rgba(255,0,200,.15)'; for(let x=-len;x<=len;x+=gap) ctx.fillRect(x,-len,sw,len*2); ctx.restore(); }
const LOOKS={warm:{low:'contrast(1.02) saturate(1.06) sepia(.06) brightness(1.02)',mid:'contrast(1.05) saturate(1.12) sepia(.10) brightness(1.03)',high:'contrast(1.09) saturate(1.2) sepia(.16) brightness(1.04)'},
cool:{low:'contrast(1.03) saturate(1.06) hue-rotate(180deg)',mid:'contrast(1.06) saturate(1.1) hue-rotate(190deg)',high:'contrast(1.1) saturate(1.18) hue-rotate(200deg)'},
teal:{low:'contrast(1.04) saturate(1.14) hue-rotate(330deg) sepia(.05)',mid:'contrast(1.08) saturate(1.22) hue-rotate(330deg) sepia(.10)',high:'contrast(1.12) saturate(1.3) hue-rotate(330deg) sepia(.16)'},
pastel:{low:'contrast(.97) saturate(.92) brightness(1.04)',mid:'contrast(.95) saturate(.88) brightness(1.06)',high:'contrast(.92) saturate(.84) brightness(1.08)'},
bw:{low:'grayscale(1) contrast(1.04) brightness(1.02)',mid:'grayscale(1) contrast(1.08) brightness(1.03)',high:'grayscale(1) contrast(1.12) brightness(1.04)'}};
function pickLook(intensity,R){ const keys=['warm','cool','teal','pastel','bw']; const k=keys[Math.floor(R()*keys.length)]; return LOOKS[k][intensity||'mid']; }
function pickAspect(ow,oh,R){ const a=[]; if(els.arOrig.checked)a.push('orig'); if(els.ar11.checked)a.push('1:1'); if(els.ar45.checked)a.push('4:5'); if(els.ar916.checked)a.push('9:16'); if(els.ar169.checked)a.push('16:9'); const tag=a.length?a[Math.floor(R()*a.length)]:'orig'; if(tag==='orig') return ow/oh; if(tag==='1:1') return 1; if(tag==='4:5') return 4/5; if(tag==='9:16') return 9/16; if(tag==='16:9') return 16/9; return ow/oh; }
function computeCrop(ow,oh,ratio,R){ const w=Math.min(ow,Math.round(oh*ratio)); const h=Math.min(oh,Math.round(ow/ratio)); const maxX=Math.max(0,ow-w), maxY=Math.max(0,oh-h); const ox=Math.round((maxX/2)+(R()-.5)*maxX*.6), oy=Math.round((maxY/2)+(R()-.5)*maxY*.6); return {sx:clamp(ox,0,maxX), sy:clamp(oy,0,maxY), sw:w, sh:h}; }
function fit(w,h,maxW,maxH){ const r=Math.min(maxW/w,maxH/h,1); return {w:Math.round(w*r),h:Math.round(h*r)}; }
function download(blob,name){ const a=document.createElement('a'); const u=URL.createObjectURL(blob); a.href=u; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(u),1200); }
function videoMeta(u){ return new Promise((res,rej)=>{ const v=document.createElement('video'); v.src=u; v.onloadedmetadata=()=>res({width:v.videoWidth,height:v.videoHeight,duration:v.duration}); v.onerror=rej; }); }
function genSeed(){ const d=new Date(); return `ads-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${Math.random().toString(16).slice(2,6)}`; }
function makeRNG(seed){ const r=mul32(hash32(seed||'seed')); const fn=()=>r(); fn.int=(a,b)=>Math.floor(r()*(b-a+1))+a; return fn; }
function hash32(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function mul32(a){ return function(){ a|=0; a=a+0x6D2B79F5|0; let t=Math.imul(a^a>>>15,1|a); t=t+Math.imul(t^t>>>7,61|t)^t; return ((t^t>>>14)>>>0)/4294967296; } }
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

/* ---------- targets: SIEMPRE intentamos MP4 + WebM ---------- */
function getTargetsBoth(){
  const mp4='video/mp4;codecs=h264';
  const webm=(MediaRecorder.isTypeSupported('video/webm;codecs=vp9')&&'video/webm;codecs=vp9')||(MediaRecorder.isTypeSupported('video/webm;codecs=vp8')&&'video/webm;codecs=vp8')||(MediaRecorder.isTypeSupported('video/webm')&&'video/webm')||'';
  const list=[];
  if(webm) list.push({label:'webm',mime:webm});
  if(MediaRecorder.isTypeSupported(mp4)) list.push({label:'mp4',mime:mp4});
  return list.length?list:[{label:'webm',mime:'video/webm'}];
}

/* ---------- SRT/VTT ---------- */
function parseSubs(text){
  if(!text) return [];
  const t = text.replace(/^\uFEFF/, '').replace(/\r/g,'');
  const blocks = t.trim().split(/\n{2,}/);
  const cues = [];
  for(const block of blocks){
    const lines = block.split('\n').filter(Boolean);
    if(!lines.length) continue;
    const i = /^\d+$/.test(lines[0].trim()) ? 1 : 0;
    if(i >= lines.length) continue;
    const arrow = lines[i].indexOf('-->');
    if(arrow<0) continue;
    const a = lines[i].slice(0,arrow).trim();
    const b = lines[i].slice(arrow+3).trim().split(/\s+/)[0];
    const txt = lines.slice(i+1).join('\n').trim();
    if(txt) cues.push({start:toSec(a), end:toSec(b), text:txt});
  }
  return cues.length ? cues : autoFromText(t, 2);
}
function toSec(s){
  s=(s||'').replace(',', '.').trim();
  const p=s.split(':').map(Number);
  if(p.length===3) return p[0]*3600 + p[1]*60 + (p[2]||0);
  if(p.length===2) return p[0]*60 + (p[1]||0);
  return Number(s)||0;
}
function autoFromText(t, per=2){
  const lines=t.split('\n').map(x=>x.trim()).filter(Boolean);
  let cur=0; return lines.map(txt=>({start:cur, end:(cur+=per), text:txt}));
}
function drawSubs(ctx,w,h,t,cues,opt){
  const c=cues.find(q=>t>=q.start&&t<q.end); if(!c) return;
  const pad=Math.round(Math.min(w,h)*0.03), f=clamp(opt.size||24,12,48); ctx.save(); ctx.font=`700 ${f}px system-ui,-apple-system,Segoe UI,Roboto,Arial`; ctx.textBaseline='bottom';
  const lines=c.text.split('\n'); const lh=Math.round(f*1.25); const mw=w-pad*2;
  const ms=tx=>ctx.measureText(tx).width; const wrap=[];
  for(const ln of lines){ const words=ln.split(' '); let line=''; for(const wd of words){ const test=line?(line+' '+wd):wd; if(ms(test)>mw){ if(line) wrap.push(line); line=wd; } else line=test; } if(line) wrap.push(line); }
  const boxW=Math.min(mw, Math.max(...wrap.map(ms))), boxH=lh*wrap.length; const x=(w-boxW)/2, y=h-pad;
  if(opt.bg){ ctx.fillStyle='rgba(0,0,0,.45)'; roundRect(ctx,x-pad*0.3,y-boxH-pad*0.2,boxW+pad*0.6,boxH+pad*0.2,Math.round(f*0.35)); ctx.fill(); }
  ctx.lineWidth=Math.max(2,Math.round(f*0.08)); ctx.strokeStyle='rgba(0,0,0,.6)'; ctx.fillStyle='#fff';
  wrap.forEach((ln,i)=>{ const tx=Math.round(w/2 - ms(ln)/2), ty=Math.round(y - (wrap.length-1-i)*lh); ctx.strokeText(ln,tx,ty); ctx.fillText(ln,tx,ty); });
  ctx.restore();
}

/* ---------- segments ---------- */
function parseSegments(s,dur){ if(!s) return []; return s.split(',').map(p=>p.trim()).map(r=>{const m=r.match(/^(\d+(?:\.\d+)?)\s*-\s*(\d+(?:\.\d+)?)$/); if(!m) return null; const a=+m[1], b=+m[2]; if(b>a && a<dur) return {start:clamp(a,0,dur), end:clamp(b,0,dur)}; return null; }).filter(Boolean); }
function seek(v,t){ return new Promise(r=>{ try{v.currentTime=t;}catch{} v.onseeked=r; v.onloadeddata&&r(); }); }
function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y,h); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

/* ---------- notas ---------- */
function updateFormatNote(){
  const mp4OK=MediaRecorder.isTypeSupported('video/mp4;codecs=h264');
  const webmOK=MediaRecorder.isTypeSupported('video/webm;codecs=vp9')||MediaRecorder.isTypeSupported('video/webm;codecs=vp8')||MediaRecorder.isTypeSupported('video/webm');
  els.formatNote.textContent=`Soporte navegador ‚Üí MP4:${mp4OK?'‚úî':'‚úñ'} / WebM:${webmOK?'‚úî':'‚úñ'}`;
}
updateFormatNote();

})();</script>
</body>
</html>
